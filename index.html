<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Divulgação CJ</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Carrega o cliente Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Um cinza bem claro para o fundo */
        }
        
        /* Novas Cores da Marca "CJ" (Rosa e Amarelo) */
        :root {
            --cor-cj-principal: #D932A3; /* Rosa Principal */
            --cor-cj-secundaria: #D932A3; /* Rosa Secundário */
            --cor-cj-destaque: #ECEC3A;  /* Amarelo Destaque */
        }

        .bg-cj-principal { background-color: var(--cor-cj-principal); }
        .text-cj-principal { color: var(--cor-cj-principal); }
        .bg-cj-secundaria { background-color: var(--cor-cj-secundaria); }
        .text-cj-secundaria { color: var(--cor-cj-secundaria); }
        .bg-cj-destaque { background-color: var(--cor-cj-destaque); }
        .text-cj-destaque { color: var(--cor-cj-destaque); }
        .border-cj-principal { border-color: var(--cor-cj-principal); }
        .border-cj-destaque { border-color: var(--cor-cj-destaque); }
        .ring-cj-secundaria { --tw-ring-color: var(--cor-cj-secundaria); }
        .ring-cj-destaque { --tw-ring-color: var(--cor-cj-destaque); }

        /* Animação de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--cor-cj-secundaria);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo para o input de arquivo */
        input[type="file"]::file-selector-button {
            background-color: var(--cor-cj-secundaria);
            color: white;
            border: 0;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #b02885; /* Um tom de rosa mais escuro para hover */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Cabeçalho com a marca -->
    <header class="bg-cj-principal shadow-lg">
        <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">
                Catálogo<span class="text-cj-destaque">.</span>CJ
            </h1>
        </div>
    </header>

    <div class="container mx-auto max-w-7xl p-4 md:p-8">
        
        <!-- Seção do Administrador (Upload) -->
        <section class="mb-12 bg-white p-6 rounded-lg shadow-md border-t-4 border-cj-destaque">
            <h2 class="text-2xl font-semibold mb-5 text-cj-principal">Painel de Upload</h2>
            
            <form id="form-upload" class="space-y-4">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome do Modelo/Produto</label>
                        <input type="text" id="nome" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 ring-cj-secundaria"
                               placeholder="Ex: Coleção Verão 2025">
                    </div>
                    <div>
                        <label for="preco" class="block text-sm font-medium text-gray-700 mb-1">Preço (Opcional)</label>
                        <input type="text" id="preco"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 ring-cj-secundaria"
                               placeholder="Ex: R$ 199,90 ou 'Consulte'">
                    </div>
                </div>

                <div>
                    <label for="arquivos" class="block text-sm font-medium text-gray-700 mb-1">Fotos e/ou Vídeos</label>
                    <input type="file" id="arquivos" multiple required
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-cj-secundaria file:text-white hover:file:bg-cj-principal cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Você pode selecionar vários arquivos de uma vez.</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Botão de Enviar com fundo Amarelo e texto Preto para contraste -->
                    <button type="submit" id="btn-submit"
                            class="w-full sm:w-auto px-8 py-3 bg-cj-destaque text-gray-900 font-bold rounded-md shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 ring-cj-destaque ring-offset-2 transition-all duration-200">
                        Enviar Arquivos
                    </button>
                    <!-- Feedback de Carregamento -->
                    <div id="feedback-upload" class="hidden flex-col items-center">
                        <div class="loader"></div>
                        <p id="feedback-texto" class="text-sm text-cj-secundaria font-medium ml-3">Enviando arquivos, por favor aguarde...</p>
                    </div>
                </div>
            </form>
        </section>

        <!-- Galeria do Catálogo (para Clientes) -->
        <section>
            <h2 class="text-2xl font-semibold mb-6 text-cj-principal border-b-2 border-gray-200 pb-2">Catálogo de Mídia</h2>
            
            <!-- Mensagem de carregamento inicial -->
            <div id="catalogo-loading" class="text-center py-10">
                <div class="loader inline-block"></div>
                <p class="text-gray-500 mt-2">Carregando catálogo...</p>
            </div>

            <!-- Onde os cards serão inseridos -->
            <div id="catalogo-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards do Supabase serão inseridos aqui -->
            </div>
            
            <p id="catalogo-vazio" class="text-gray-500 text-center py-10 hidden">O catálogo está vazio. Faça o primeiro upload!</p>
        </section>

    </div>

    <!-- Módulo JavaScript com Supabase (AGORA ATIVADO) -->
    <script type="module">
        // Importa a função createClient do Supabase
        const { createClient } = supabase;

        // =======================================================================
        //     CONFIGURAÇÃO DO SUPABASE (COPIADO DA SUA MENSAGEM)
        // =======================================================================
        const SUPABASE_URL = 'https://pxuesehwihaiiccdzvjt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4dWVzZWh3aWhhaWljY2R6dmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjU1ODQsImV4cCI6MjA3NjQwMTU4NH0.mmTpAjLM2hwqHF60X9jskX7qxj9PuqUwTnNFBM6aPo4';
        
        // Nomes da tabela e do bucket (devem ser os mesmos do arquivo schema.sql)
        const NOME_TABELA_DB = 'catalogo_cj';
        const NOME_BUCKET_STORAGE = 'catalogo_midia';
        // =======================================================================

        // --- Elementos da UI ---
        const form = document.getElementById('form-upload');
        const btnSubmit = document.getElementById('btn-submit');
        const feedbackUpload = document.getElementById('feedback-upload');
        const feedbackTexto = document.getElementById('feedback-texto');
        
        const grid = document.getElementById('catalogo-grid');
        const loadingMsg = document.getElementById('catalogo-loading');
        const emptyMsg = document.getElementById('catalogo-vazio');
        
        let client;

        // --- CRIAR ELEMENTO DO CARD ---
        function criarCard(item) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col group transition-transform duration-300 hover:scale-105';

            let mediaHtml = '';
            // Verifica se é imagem ou vídeo
            if (item.tipo && item.tipo.startsWith('image/')) {
                mediaHtml = `<img src="${item.fileURL}" alt="${item.nome}" class="w-full h-full object-cover" loading="lazy">`;
            } else if (item.tipo && item.tipo.startsWith('video/')) {
                mediaHtml = `<video controls muted loop class="w-full h-full object-cover"><source src="${item.fileURL}" type="${item.tipo}"></video>`;
            } else {
                // Fallback para tipos desconhecidos
                mediaHtml = `<div class="p-4 text-center text-gray-500">Mídia não suportada para preview</div>`;
            }

            const precoHtml = item.preco ? `<p class="text-md text-cj-secundaria font-bold">${item.preco}</p>` : '';

            card.innerHTML = `
                <div class="relative h-64 bg-gray-200">
                    ${mediaHtml}
                </div>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold text-gray-800 truncate" title="${item.nome}">
                        ${item.nome}
                    </h3>
                    ${precoHtml}
                </div>
                <div class="p-3 bg-gray-50 border-t">
                    <a href="${item.fileURL}" download="${item.nomeArquivo}" target="_blank"
                       class="w-full text-center block px-4 py-2 bg-cj-secundaria text-white text-sm font-medium rounded-md hover:bg-cj-principal transition-colors">
                        Baixar Mídia
                    </a>
                </div>
            `;
            return card;
        }

        // --- Código do Supabase ---
        
        try {
            // Inicializa o cliente Supabase
            client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Inicia o carregamento do catálogo
            carregarCatalogo();
            
            // Inicia o listener de tempo real
            iniciarListenerRealtime();

        } catch (e) {
            console.error("Erro ao inicializar o Supabase:", e);
            loadingMsg.innerText = "Erro ao conectar ao banco de dados. Verifique a configuração do Supabase.";
            console.warn("Verifique se você executou o arquivo schema.sql no seu painel Supabase.");
        }

        /**
         * CARREGAR CATÁLOGO (SUPABASE DB)
         */
        async function carregarCatalogo() {
            if (!client) return;

            const { data, error } = await client
                .from(NOME_TABELA_DB)
                .select('*')
                .order('created_at', { ascending: false });

            loadingMsg.classList.add('hidden');

            if (error) {
                console.error("Erro ao buscar catálogo: ", error);
                loadingMsg.innerText = "Erro ao carregar catálogo.";
                return;
            }

            grid.innerHTML = ''; // Limpa o grid para recarregar
            if (data.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                data.forEach(item => {
                    const card = criarCard(item);
                    grid.appendChild(card);
                });
            }
        }
        
        /**
         * Ouve por mudanças em tempo real (Novos uploads)
         */
        function iniciarListenerRealtime() {
            if (!client) return;
            
            client.channel('catalogo-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: NOME_TABELA_DB }, 
                    (payload) => {
                        console.log('Novo item detectado!', payload.new);
                        // Adiciona o novo card no topo da lista
                        const card = criarCard(payload.new);
                        grid.prepend(card);
                        emptyMsg.classList.add('hidden');
                    }
                )
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Conectado ao canal de tempo real do Supabase!');
                    }
                    if (err) {
                        console.error('Erro no canal Supabase:', err);
                    }
                });
        }


        /**
         * LIDAR COM O UPLOAD (SUPABASE STORAGE)
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!client) {
                alert("Erro: O Supabase não está conectado.");
                return;
            }

            const nome = document.getElementById('nome').value;
            const preco = document.getElementById('preco').value;
            const arquivos = document.getElementById('arquivos').files;

            if (arquivos.length === 0) {
                alert("Por favor, selecione pelo menos um arquivo.");
                return;
            }

            // Mostra o feedback de carregamento
            btnSubmit.disabled = true;
            btnSubmit.classList.add('opacity-50');
            feedbackUpload.classList.remove('hidden');
            feedbackUpload.classList.add('flex');

            try {
                // Faz o upload de cada arquivo
                for (let i = 0; i < arquivos.length; i++) {
                    const file = arquivos[i];
                    feedbackTexto.innerText = `Enviando ${i + 1} de ${arquivos.length}: ${file.name}...`;

                    // 1. Cria um nome de arquivo único
                    const nomeUnico = `${Date.now()}-${file.name}`;

                    // 2. Faz o upload do arquivo para o Supabase Storage
                    const { data: uploadData, error: uploadError } = await client.storage
                        .from(NOME_BUCKET_STORAGE)
                        .upload(nomeUnico, file);
                    
                    if (uploadError) throw uploadError;

                    // 3. Pega a URL pública do arquivo
                    const { data: urlData } = client.storage
                        .from(NOME_BUCKET_STORAGE)
                        .getPublicUrl(uploadData.path);

                    const fileURL = urlData.publicUrl;

                    // 4. Salva as informações no Supabase Database
                    const { error: dbError } = await client
                        .from(NOME_TABELA_DB)
                        .insert({
                            nome: nome,
                            preco: preco,
                            fileURL: fileURL,
                            tipo: file.type, // Salva o tipo (image/png, video/mp4, etc)
                            nomeArquivo: file.name
                            // created_at é definido por padrão no SQL
                        });
                    
                     if (dbError) throw dbError;
                }
                
                // Limpa o formulário e reseta o botão
                form.reset();
                feedbackTexto.innerText = `Enviado com sucesso!`;
                
            } catch (error) {
                console.error("Erro durante o upload: ", error);
                feedbackTexto.innerText = "Erro ao enviar. Tente novamente.";
                alert("Houve um erro no upload: " + error.message);
            } finally {
                // Esconde o feedback e reativa o botão
                setTimeout(() => {
                    feedbackUpload.classList.add('hidden');
                    btnSubmit.disabled = false;
                    btnSubmit.classList.remove('opacity-50');
                    feedbackTexto.innerText = "Enviando arquivos, por favor aguarde...";
                }, 2000);
            }
        });

    </script>

</body>
</html>

